---
title: "synthdid introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{synthdid introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
set.seed(42)
```

```{r setup}
library(synthdid)
library(ggplot2)
library(mvtnorm)
```

So the vignette is not cluttered by warnings, we suppress them here. 
Displaying some plots warns because they use aesthetics that are
understood by ggplotly but not ggplot2.
```{r}
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
```

# Example use 
We estimate the effect of California Proposition 99 on cigarette consumption

## Standard Errors
We have only one treated unit (California), so the only implemented method to estimate
the standard error is the 'placebo' method described in Section 5 of Arkhangelsky et al. 
Because this is not trustworthy, it is not used by default: vcov instead returns NA.
Here it is probably too large. 

But to show how confidence intervals are constructed and displayed, we'll use it anyway.
To do this, we pass method='placebo' to vcov and pass se.method='placebo' 
to our plotting functions so they do the same. 
If we didn't, the plots wouldn't show have standard errors.
```{r}
data('california_prop99')
setup = panel.matrices(california_prop99)
tau.hat = synthdid_estimate(setup$Y, setup$N0, setup$T0)
se = sqrt(vcov(tau.hat, method='placebo'))
print(paste0("point estimate: ", round(tau.hat, 2)))
print(paste0("95% CI for tau: (", round(tau.hat - 1.96 * se, 2), ", ", 
                                  round(tau.hat + 1.96 * se, 2), ")"))
```

## The parallel trends plot. 
  We show the trajectories of California  and the synthetic control we compare it to, 
  with a vertical line indicating onset of treatment. The relative size of the 
  weights $\lambda_t$ for pre-treatment periods are shown on the bottom. 
  Overlaid is a diagram of the estimate. 
  
### The Parallelogram
  The blue segment shows the change from the weighted pre-treatment average 
  to the post-treatment average California. The red one does the same for
  a synthetic control. 
  
### The Hallucination
  Our premise is that, absent treatment, California would change like
  the synthetic control: from California's pre-treatment average,
  we draw a dashed segment parallel to the control's red one.
  Where it ends is our estimate of what we'd have observed in California had, 
  contrary to fact, it not been treated. 
  
### The Treatment Effect
  Comparing this counterfactual estimate to what we observed in 
  the real world, we get a treatment effect. We show it with a black arrow. 
  We show a 95% confidence interval with two gray arrows: 
  one for the upper confidence bound and one for the lower.
  
```{r, fig.width=7, fig.height=4}
plot(tau.hat, se.method='placebo')
```

## The control unit contribution plot. 
  We could draw the plot above, and get a questionable treatment effect estimate,
  by comparison to any individual control state. Our actual estimate is a weighted average
  of these: the weights are the synthetic control weights $\omega_i$. This plot
  shows each individual comparison with a dot, with weight $\omega_i$ determining the dot size.
  The black horizontal line shows the actual effect; 
  the gray ones show the endpoints of a 95% confidence interval.

```{r, fig.width=7, fig.height=4}
synthdid_units_plot(tau.hat, se.method='placebo')
```

## Checking for pre-treatment parallel trends
When the synthetic control and treated trajectories are far from one another,
it can be hard to see how parallel they are. Pass overlay=1 to plot to overlay them. 

```{r, fig.width=7, fig.height=4}
plot(tau.hat, overlay=1,  se.method='placebo')
```
Pass values between zero and one to shift the control's trajectory
toward California.
```{r, fig.width=7, fig.height=4}
plot(tau.hat, overlay=.8, se.method='placebo')
```

# Compare to other estimators
We compare to synthetic control and diff-in-diff. 
This reproduces Figure 1 of Arkhangelsky et al.
```{r}
tau.sc   = sc_estimate(setup$Y, setup$N0, setup$T0)
tau.did  = did_estimate(setup$Y, setup$N0, setup$T0)
estimates = list(tau.did, tau.sc, tau.hat)
names(estimates) = c('Diff-in-Diff', 'Synthetic Control', 'Synthetic Diff-in-Diff')
```
```{r, fig.width=7, fig.height=4}
synthdid_plot(estimates, se.method='placebo')
```
```{r, fig.width=15, fig.height=5}
synthdid_units_plot(estimates, se.method='placebo')
```

# Customize plots 
Arguments to plotting functions can change the transparency, line thickness, etc. of individual elements.
The output of every plotting function is a ggplot, so you can change theme, legend position, etc. as usual.
We'll use these to match the style of Arkhangelsky et al.
```{r, fig.width=15, fig.height=5}
synthdid_plot(estimates, facet.vertical=FALSE, 
              control.name='control', treated.name='california', 
              lambda.comparable=TRUE, se.method = 'none', 
              trajectory.linetype = 1, line.width=.75, effect.curvature=-.4,
              trajectory.alpha=.7, effect.alpha=.7, 
              diagram.alpha=1, onset.alpha=.7) + 
    theme(legend.position=c(.26,.07), legend.direction='horizontal', 
          legend.key=element_blank(), legend.background=element_blank(),
          strip.background=element_blank(), strip.text.x = element_blank())

synthdid_units_plot(estimates, se.method='none') + 
    theme(legend.background=element_blank(), legend.title = element_blank(), 
          legend.direction='horizontal', legend.position=c(.17,.07), 
	  strip.background=element_blank(), strip.text.x = element_blank())
```

# Complex Plots
We can even overlay multiple estimates in one plot and include a magnified view of some regions.
We create a flipbook in which we bring synthetic diff-in-diff's control
closer to California's trajectory to we can see how parallel it is clearly, overlay it completely
so we can better compare it to the ADH synthetic control method's synthetic control,
plot the ADH synthetic control estimate, and zoom in on a region around treatment onset
in which we can see the ADH synthetic control possibly begin to diverge from California's trajectory.

Because we display multiple estimates, we cannot use the overlay parameter to slide synthetic
diff-in-diff's control toward California. Instead, we pass this parameter as an attribute
'overlay' of the estimator, which overrides the function argument and is interpreted the same way.
Including an invisible (via alpha.multiplier) copy of tau.hat keeps the axes of the plot
from changing as the visible one's control trajectory moves.
```{r, fig.width=7, fig.height=4.5, fig.show='animate', ffmpeg.format='gif', dev='jpeg'}
with.overlay = function(est, s) { attr(est,'overlay') = s; est } 
estimators = function(s) { 
  estimator.list = list(with.overlay(tau.hat, s), tau.sc, tau.hat); 
  names(estimator.list)=c('sdid', 'sc', ''); 
  estimator.list
}

plot.estimators = function(ests, alpha.multiplier) {
  synthdid_plot(ests, se.method='none', 
                alpha.multiplier=alpha.multiplier, facet=rep(1,length(ests)),
	              trajectory.linetype = 1, effect.curvature=-.4,
	              trajectory.alpha=.5, effect.alpha=.5, diagram.alpha=1) + 
	  scale_color_viridis_d(drop=FALSE) + 
    scale_fill_viridis_d(drop=FALSE) + 
    scale_alpha(range=c(0,1), guide='none') 
}

# set up the box we zoom in on in plot 5
time = as.integer(colnames(setup$Y))
lambda = attr(tau.hat,'weights')$lambda
xbox.ind = c(which(lambda > .01)[1], setup$T0+4)
xbox = time[xbox.ind] + c(-.5,.5)
ybox = range(setup$Y[setup$N0+1, min(xbox.ind):(max(xbox.ind))]) + c(-4,4)


p1 = plot.estimators(estimators(0),   alpha.multiplier=c(1,.1,0))  
p2 = plot.estimators(estimators(.75), alpha.multiplier=c(1,.1,0)) 
p3 = plot.estimators(estimators(1),   alpha.multiplier=c(1,.1,0)) 
p4 = plot.estimators(estimators(1),   alpha.multiplier=c(1, 1,0)) 
p4.zoom = p4 + coord_cartesian(xlim=xbox, ylim=ybox) + xlab('') + ylab('') + 
    theme(axis.ticks.x= element_blank(), axis.text.x = element_blank(), 
          axis.ticks.y=element_blank(), axis.text.y=element_blank(), 
          legend.position='off')
p5 = p4 + annotation_custom(ggplotGrob(p4.zoom), xmin = 1968,   # location by
                            xmax = 1984.7,   ymin=2, ymax=95) + # trial and error
	        geom_rect(aes(xmin=min(xbox), xmax=max(xbox), 
	                      ymin=min(ybox), ymax=max(ybox)), 
	                  color=alpha('black', .25), size=.3, fill=NA)


plot.theme = theme(legend.position=c(.9,.85), legend.direction='vertical', 
                   legend.key=element_blank(), legend.background=element_blank())

p1 + plot.theme
p2 + plot.theme
p3 + plot.theme
p4 + plot.theme
p5 + plot.theme
```