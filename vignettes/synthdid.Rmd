---
title: "synthdid introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{synthdid introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
set.seed(42)
```

```{r setup}
library(synthdid)
library(ggplot2)
library(mvtnorm)
options(warn = -1)  
# some of the plotting functions make irrelevant warnings. Suppress them here.
```

# Example use 
We estimate the effect of California Proposition 99 on cigarette consumption
We have only one treated unit (California), so the only implemented method to estimate
the standard error is the 'placebo' method described in Section 5 of Arkhangelsky et al. 
Because this is often not trustworthy, this is not used by default: vcov instead returns NA.
Here, just for fun, we explicitly request the placebo standard error be used.

## Plots
### A parallel trends plot. 
  We show the trajectories of California and the synthetic control we compare it to, 
  with a vertical line indicating onset of treatment. The weights lambda_t for pre-treatment
  periods are shown on the bottom. Overlaid is a diagram of the estimate. 
  Four points indicate the weighted pre-treatment average and post-treatment average 
  for California and our synthetic control. Starting at California's pre-treatment average,
  we draw a (dashed) line parallel to the line connecting the synthetic control's
  pre and post-treatment average. Its post-treatment average, the fifth point, 
  is our estimate of what we'd have observed in California had, contrary to fact, it not been treated.
  Comparing this to what we observed in the real world gives us a treatment effect, indicated by a black arrow. 
  we show a 95% confidence interval with two gray arrows, one for the upper confidence bound 
  and one for the lower.
### A control unit contribution plot. 
  This decomposes the estimate as a weighted average of diff-in-diff comparisons to individual control states:
  the difference between the average post-treatment consumption of California and the control, adjusted by
  subtracting the difference between the lambda_t-weighted pre-treatment averages.
  The size of the dot indicates the weight, omega_i, for the control state in the average that is our
  average treatment effect estimate, shown as a black horizontal line. A 95% confidence interval
  for the average treatment effect is illustrated with two gray horizontal lines.

## Checking for pre-treatment parallel trends
When the synthetic control and treated trajectories are far from one another in the 
parallel trends plot, it can be hard to see how parallel they are. Pass overlay=1
to plot to overlay them and values between zero and one to shift the control's trajectory
toward California.
```{r}
data('california_prop99')
setup = panel.matrices(california_prop99)
tau.hat = synthdid_estimate(setup$Y, setup$N0, setup$T0)
se = sqrt(vcov(tau.hat, method='placebo'))
print(paste0("point estimate: ", round(tau.hat, 2)))
print(paste0("95% CI for tau: (", round(tau.hat - 1.96 * se, 2), ", ", round(tau.hat + 1.96 * se, 2), ")"))

plot(tau.hat, se.method='placebo')
synthdid_units_plot(tau.hat, se.method='placebo')

plot(tau.hat, overlay=1,  se.method='placebo')
plot(tau.hat, overlay=.8, se.method='placebo')
```

# Compare to synthetic control and diff-in-diff estimates. 
Reproduces Figure 1 of the paper `Synthetic Difference in Differences' 
```{r}
tau.sc   = sc_estimate(setup$Y, setup$N0, setup$T0)
tau.did  = did_estimate(setup$Y, setup$N0, setup$T0)
estimates = list(tau.did, tau.sc, tau.hat)
names(estimates) = c('Diff-in-Diff', 'Synthetic Control', 'Synthetic Diff-in-Diff')
synthdid_plot(estimates, se.method='placebo')
synthdid_units_plot(estimates, se.method='placebo')
```

# Customize plots 
We'll now match the paper style.
Arguments to plotting functions can change the transparency, line thickness, etc. of individual elements.
The output of every plotting function is a ggplot, so you can change theme, legend position, etc. as usual.
```{r}
synthdid_plot(estimates, facet.vertical=FALSE, control.name='control', treated.name='california', 
              lambda.comparable=TRUE, se.method = 'none', trajectory.linetype = 1, line.width=.75, effect.curvature=-.4,
              trajectory.alpha=.7, effect.alpha=.7, diagram.alpha=1, onset.alpha=.7, ) + 
    theme(legend.position=c(.26,.07), legend.direction='horizontal', legend.key=element_blank(), legend.background=element_blank(),
    strip.background=element_blank(), strip.text.x = element_blank())

synthdid_units_plot(estimates, se.method='none') + 
    theme(legend.background=element_blank(), legend.title = element_blank(), legend.direction='horizontal', legend.position=c(.17,.07), 
	  strip.background=element_blank(), strip.text.x = element_blank())
```

# Complex Plots
We can even overlay multiple estimates in one plot and include a magnified view of some regions.
We create a 'flipbook' in which we bring synthetic diff-in-diff's control
closer to California's trajectory to we can see how parallel it is clearly, overlay it completely
so we can better compare it to the ADH synthetic control method's synthetic control,
plot the ADH synthetic control estimate, and zoom in on a region around treatment onset
in which we can see the ADH synthetic control possibly begin to diverge from California's trajectory.

Because we display multiple estimates, we cannot use the overlay parameter to slide synthetic
diff-in-diff's control toward California. Instead, we pass this parameter as an attribute
'overlay' of the estimator, which overrides the function argument and is interpreted the same way.
Including an invisible (via alpha.multiplier) copy of tau.hat keeps the axes of the plot
from changing as we the visible one's control trajectory moves.
```{r}
with.overlay = function(est, s) { attr(est,'overlay') = s; est } 
estimators = function(s) { l = list(with.overlay(tau.hat, s), tau.sc, tau.hat); names(l)=c('sdid', 'sc', ''); l }

plot.estimators = function(ests, alpha.multiplier) {
  synthdid_plot(ests, se.method='none', alpha.multiplier=alpha.multiplier, facet=rep(1,length(ests)),
	trajectory.linetype = 1, trajectory.alpha=.5, effect.alpha=.5, diagram.alpha=1, effect.curvature=-.4) + 
	scale_color_viridis_d(drop=FALSE) + scale_fill_viridis_d(drop=FALSE) + scale_alpha(range=c(0,1), guide='none') 
}

# set up the box we zoom in on in plot 5
time = as.integer(colnames(setup$Y))
lambda = attr(tau.hat,'weights')$lambda
xbox.ind = c(which(lambda > .01)[1], setup$T0+4)
xbox = time[xbox.ind] + c(-.5,.5)
ybox = range(setup$Y[setup$N0+1, min(xbox.ind):(max(xbox.ind))]) + c(-4,4)

plot.theme = theme(legend.position=c(.9,.85), legend.direction='vertical', legend.key=element_blank(), legend.background=element_blank())
p1 = plot.estimators(estimators(0),   alpha.multiplier=c(1,.1,0)) + plot.theme
p2 = plot.estimators(estimators(.75), alpha.multiplier=c(1,.1,0)) + plot.theme
p3 = plot.estimators(estimators(1),   alpha.multiplier=c(1,.1,0)) + plot.theme
p4 = plot.estimators(estimators(1),   alpha.multiplier=c(1, 1,0)) + plot.theme
p4.zoom = p4 + coord_cartesian(xlim=xbox, ylim=ybox) + xlab('') + ylab('') + 
    theme(axis.ticks.x= element_blank(), axis.text.x = element_blank(), axis.ticks.y=element_blank(), axis.text.y=element_blank(), legend.position='off')
p5 = p4 + annotation_custom(ggplotGrob(p4.zoom), xmin = 1968, xmax = 1984.7,   ymin=2, ymax=95) + # manually adjusted zoom box location
	  geom_rect(aes(xmin=min(xbox), xmax=max(xbox), ymin=min(ybox), ymax=max(ybox)), color=alpha('black', .25), size=.3, fill=NA)

p1
p2
p3
p4
p5


```